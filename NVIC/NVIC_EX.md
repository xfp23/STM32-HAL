# STM32 HAL库开发指南
**本频道只提供STM32 HAL库编程方法，不提供知识点注解**

# 版权信息

© 2024 . 未经许可不得复制、修改或分发。 此文献为 [小風的藏書閣](https://t.me/xfp2333) 所有。

# STM32中断知识点扩展

在 STM32 的中断优先级配置中，常见的优先级划分为 **抢占优先级** 和 **子优先级**（又称为响应优先级或次优先级），这些优先级用于控制中断的响应顺序。

### 1. 抢占优先级（Preemption Priority）
- 抢占优先级决定了中断的整体优先级。
- 当两个中断同时发生或者一个中断正在执行时，如果另一个中断的抢占优先级更高，则新的中断会**打断当前的中断处理**，抢先执行。
- 抢占优先级越低，优先级越高（如 0 是最高优先级）。

### 2. 子优先级（Subpriority）
- 子优先级决定了当抢占优先级相同时，哪个中断会先响应。
- 如果两个中断具有相同的抢占优先级，那么系统会根据子优先级来决定哪个中断先执行。
- 子优先级不会影响中断的抢占顺序，它只影响同一抢占优先级下中断的执行顺序。

### 实际应用
STM32 中断的优先级由 **NVIC**（Nested Vectored Interrupt Controller）管理。在 NVIC 中，优先级分配方式如下：

- 优先级分成 `4-bit` 编码，可在配置中进行分组选择。例如，优先级可分为：
  - 2 位用于抢占优先级，2 位用于子优先级
  - 或者 3 位用于抢占优先级，1 位用于子优先级
- 你可以在 `stm32f4xx_hal_conf.h` 中设置优先级的分配方式，比如使用 `HAL_NVIC_SetPriorityGrouping()`。

### 示例代码
```c
// 设定中断优先级分组：2 位抢占优先级，2 位子优先级
HAL_NVIC_SetPriorityGrouping(NVIC_PRIORITYGROUP_2);

// 配置中断优先级，TIM2 中断抢占优先级为 1，子优先级为 0
HAL_NVIC_SetPriority(TIM2_IRQn, 1, 0);
HAL_NVIC_EnableIRQ(TIM2_IRQn);
```

在这个例子中：
- 抢占优先级为 1，比 0 的优先级低。
- 子优先级为 0，在同级别的抢占优先级中会优先触发。

### 何时使用抢占优先级和子优先级
- 如果有一些任务必须**绝对优先执行**，则分配较高的抢占优先级。
- 如果某些中断**可能会影响其他中断**的延时，但不需要强行抢占，可以在抢占优先级相同的情况下调整子优先级。