# STM32 HAL库开发指南
**本频道只提供idf编程方法，不提供知识点注解**

# 版权信息

© 2024 . 未经许可不得复制、修改或分发。 此文献为 [小風的藏書閣](https://t.me/xfp2333) 所有。

# STM32 PWM编程指南


# 配置CubeMX
# STM32 HAL库开发指南
**本频道只提供STM32 HAL库编程方法，不提供知识点注解**

# 版权信息

© 2024 . 未经许可不得复制、修改或分发。 此文献为 [小風的藏書閣](https://t.me/xfp2333) 所有。

# STM32 PWM编程指南

- 首先根据本文档的[定时器章节](/Timer/Timer.md)配置一个1ms的定时器，与之前不同，此定时器不使能中断

# CubeMX配置

1. 设置1ms的定时器成功后，选择`CubeMX`的`channel`选项卡，通道设置为带`PWM`前缀的模式

2. channel中的选项说明

| **选项**                      | **说明**                                                                                 |
|-------------------------------|------------------------------------------------------------------------------------------|
| **PWM Mode (PWM 模式)**       | 用于输出 PWM 信号。通过设置比较值来调节占空比。常用配置之一。                               |
| **Output Compare Mode (OC)**  | 用于输出比较模式。产生特定的输出电平变化，适用于定时触发等场景。                               |
| **Input Capture Mode (IC)**   | 输入捕获模式，用于测量外部信号的脉宽和频率等参数。                                           |
| **One Pulse Mode (OPM)**      | 单脉冲模式，产生一个脉冲信号后自动停止计数，适合单次触发操作。                                   |
| **Forced Active Mode**        | 强制输出为高电平。                                                                        |
| **Forced Inactive Mode**      | 强制输出为低电平。                                                                        |
| **Toggle Mode**               | 每次触发更新事件后翻转输出电平，用于输出交替的高低电平信号。                                   |
| **Complementary PWM Mode**    | 互补 PWM 模式，配合死区时间控制用于驱动半桥电路，适用于电机控制。                               |
| **Edge-Aligned Mode**         | 边沿对齐模式，PWM 输出在计数器到达指定值时变化，产生经典的边沿对齐 PWM 信号。                    |
| **Center-Aligned Mode**       | 中心对齐模式，PWM 输出在计数器从最低值到达最高值并回到最低值期间对称输出，适合电机控制。           |
| **Capture/Compare Polarity**  | 捕获/比较极性设置，确定 PWM 输出或输入捕获的触发边沿（上升沿、下降沿或双边沿）。                   |
| **Capture/Compare Pre-scaler**| 捕获/比较预分频，用于调整信号频率，使得定时器能够以适合的时间间隔进行捕获。                        |
| **Capture/Compare Filter**    | 捕获/比较滤波器，用于去除输入信号中的高频噪声。


3. pwm的输出模式中的后缀意义，选择前缀为PWM的通道

在 STM32 定时器的 PWM 输出模式中，通道后缀（如 `CH1`、`CH1N`、`CH1_CH1N`）用于区分输出引脚的配置及其用途。以下是这些后缀的含义：

| **后缀**      | **说明**                                                                                                                                 |
|---------------|------------------------------------------------------------------------------------------------------------------------------------------|
| **CH1**       | **主通道 1**。定时器的通道 1 输出，标准的 PWM 输出模式，信号在指定的输出引脚上产生，例如 `TIMx_CH1`。用于普通的 PWM 输出。              |
| **CH1N**      | **主通道 1 的互补输出**。该通道通常用于与 `CH1` 配合，产生反相信号，且有死区时间保护，用于 H 桥、半桥电路控制，应用于电机驱动等场景。|
| **CH1_CH1N**  | **主通道 1 及其互补输出的组合**。该设置包括 `CH1` 和 `CH1N` 两个输出信号，适用于需要同时使用 PWM 主输出和互补输出的场合。         |

### 使用场景
- **CH1**：单一 PWM 输出场合，如简单的 LED 调光。
- **CH1N**：与 `CH1` 配合，用于电机驱动等场景，提供互补信号以控制不同功率晶体管的导通和关断。
- **CH1_CH1N**：需要互补输出并对信号进行死区时间控制的场景，如全桥、半桥驱动电路。

4. 设置完channel之后点击CubeMX下方弹出参数设置选项卡中的对应通道的设置

| **选项**                     | **说明**                                                                                  |
|------------------------------|-------------------------------------------------------------------------------------------|
| **Mode**                     | PWM 的模式选择，通常为 `PWM1` 或 `PWM2`。`PWM1` 模式在计数器小于比较值时输出高电平，反之低电平；`PWM2` 模式相反。       |
| **Pulse**                    | 初始占空比，通常设置为 `0`，可以动态调整以改变占空比。                                     |
| **Output Compare Preload**   | 输出比较寄存器的预加载，通常设置为 `Enable` 以确保 PWM 输出更新的平滑性和稳定性。           |
| **CH Polarity**              | 主通道的输出极性。设置为 `High` 表示正极性，输出为高电平。`Low` 则为负极性。                |
| **CHN Polarity**             | 互补输出的极性。设置为 `High` 表示互补输出为正极性，`Low` 表示为负极性，配合死区时间使用。


# 配置一个PWM输出

## 配置输出频率

在 STM32 中，设置 PWM 的频率需要调整 **定时器的时钟频率** 和 **PWM 的周期（通过 ARR 和 PSC 寄存器）**。


### PWM 输出频率的计算公式：


\[
f_{\text{PWM}} = \frac{f_{\text{TimerClock}}}{(\text{PSC} + 1) \times (\text{ARR} + 1)}
\]


其中：
-  $\( f_{\text{TimerClock}} \)$  是定时器的输入时钟频率。
-  $\( \text{PSC} \)$ 是预分频器的值（寄存器值范围：0 ~ 65535）。
-  $\( \text{ARR} \)$ 是自动重装载寄存器的值（寄存器值范围：0 ~ 65535）。

### 设置步骤：
#### 1. 确定时钟源和定时器输入频率
定时器时钟频率通常来自 APB 时钟（PCLK）。在 STM32 的系统时钟配置中，需确认 APB 总线时钟频率和定时器的倍频关系：
- 如果 APB 预分频因子为 1，则  $\( f_{\text{TimerClock}} = f_{\text{PCLK}} \)$ 。
- 如果 APB 预分频因子不为 1，则 $\( f_{\text{TimerClock}} = f_{\text{PCLK}} \times 2 \)$ 。

例如，如果 APB1 总线频率为 170 MHz，APB1 的预分频因子为 1，则定时器的输入时钟频率也是 170 MHz。

---

#### 2. 选择 PWM 的目标频率
假设需要设置 PWM 频率为 **1 kHz**。

---

#### 3. 计算 PSC 和 ARR


\[
\text{PSC} + 1 = \frac{f_{\text{TimerClock}}}{f_{\text{DesiredTimer}}}
\]


选择一个合适的预分频器（PSC），然后通过 ARR 调整 PWM 周期。  
假设 $\( f_{\text{TimerClock}} = 170 \, \text{MHz} \)，并希望 \( f_{\text{PWM}} = 1 \, \text{kHz} \)$ :

1. 初步选择 $\( \text{PSC} = 1699 \)$ : 
$\[
   f_{\text{Timer}} = \frac{170 \, \text{MHz}}{1699 + 1} = 100 \, \text{kHz}
   \]
$

2. 计算 ARR：

$
\[
\text{ARR} = \frac{f_{\text{Timer}}}{f_{\text{PWM}}} - 1 = \frac{100 \, \text{kHz}}{1 \, \text{kHz}} - 1 = 99
\]
$

最终：
- $\( \text{PSC} = 1699 \)$ 
- $\( \text{ARR} = 99 \)$ 

---

#### 4. 配置占空比（CCR）
占空比通过 **捕获比较寄存器（CCR）** 配置。占空比公式：

$
\[
\text{占空比 (\%)} = \frac{\text{CCR}}{\text{ARR} + 1} \times 100
\]
$

例如：
- 设置 $\( \text{CCR} = 50 \)$，占空比为 50%。
- 设置 $\( \text{CCR} = 25 \)$，占空比为 25%。

---



## 程序示例:

```c

// 必须在主循环之前调用此函数使能pwm输出
    HAL_TIM_PWM_Start(&htim2,TIM_CHANNEL_1);



// 启动 PWM 输出
HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_1);

// 设置占空比为 50%
uint32_t ARR = __HAL_TIM_GET_AUTORELOAD(&htim2);
uint32_t CCR = (ARR + 1) * 0.5;  // 占空比 50%
__HAL_TIM_SET_COMPARE(&htim2, TIM_CHANNEL_1, CCR);

```
